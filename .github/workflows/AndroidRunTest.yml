  name: Run android tests in GitHub Runner

  on:
    push:
      branches: [master]
    workflow_dispatch:

  jobs:
    test:
      runs-on: windows-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2

        - name: Set up JDK 17
          uses: actions/setup-java@v2
          with:
            distribution: 'temurin'
            java-version: 17

        - name: Set up Node.js
          uses: actions/setup-node@v2
          with:
            node-version: '16.13.0'

        - name: Install Appium
          run: |
            npm install -g appium@v2.5.1
            appium -v
        - name: Install UIAutomator2 driver for Appium
          run: |
            appium driver install uiautomator2@3.0.1
        - name: Start Appium server
          run: |
            appium &> appium.log 
            Start-Sleep -Seconds 20
          env:
            ANDROID_HOME: C:\Users\runneradmin\AppData\Local\Android\Sdk
            ANDROID_SDK_ROOT: C:\Users\runneradmin\AppData\Local\Android\Sdk

        - name: Verify Appium server
          run: |
            curl -X GET http://127.0.0.1:4723/status

        - name: Set up Android SDK
          uses: android-actions/setup-android@v2
          with:
            api-levels: 34
            target: default
            arch: x86_64
            channel: stable

        - name: Install Android SDK packages
          run: |
            sdkmanager --install 'system-images;android-34;google_apis;x86_64'
            sdkmanager --install 'platform-tools'
            sdkmanager --install 'emulator'
        - name: Accept SDK licenses
          run: |
            echo y | sdkmanager --licenses
        - name: Create AVD
          run: |
            echo no | avdmanager create avd -n test -k "system-images;android-34;google_apis;x86_64" --force
        - name: Start emulator
          run: |
            emulator -avd test -no-window -no-audio -no-boot-anim &
            Start-Sleep -Seconds 120
          env:
            ANDROID_SDK_ROOT: C:\Users\runneradmin\AppData\Local\Android\Sdk


        - name: Add Maven to PATH
          run: |
            echo "C:\\ProgramData\\chocolatey\\bin" >> $env:GITHUB_PATH
        - name: Verify Maven installation
          run: |
            mvn -version
        - name: Run Android Tests
          run: |
            echo "JAVA_HOME: $env:JAVA_HOME"
            mvn -Dtest=TestRunner test
          env:
            ANDROID_HOME: C:\Users\runneradmin\AppData\Local\Android\Sdk
            ANDROID_SDK_ROOT: C:\Users\runneradmin\AppData\Local\Android\Sdk
        - name: Display Appium Logs
          run: |
            type appium.log