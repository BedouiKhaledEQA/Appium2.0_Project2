name: Test Appium avec Genymotion et Rapport Allure

on: [push]

jobs:
  test-appium:
    runs-on: ubuntu-latest
    steps:
      # Étape 1 : Cloner le dépôt
      - uses: actions/checkout@v2

      # Étape 2 : Installer Node.js 16
      - name: Installer Node.js 16
        run: |
          curl -fsSL https://deb.nodesource.com/setup_16.x | bash -
          apt-get install -y nodejs

      # Étape 3 : Installer Appium
      - name: Installer Appium
        run: npm install -g appium

      # Étape 4 : Lancer le serveur Appium
      - name: Lancer le serveur Appium
        run: |
          appium &

      # Étape 5 : Télécharger l'image Android
      - name: Télécharger l'image Android
        uses: actions/download-artifact@v2
        with:
          name: genymotion-image
          path: android-emulator

      # Étape 6 : Installer adb
      - name: Installer adb
        run: sudo apt-get update && sudo apt-get install -y android-tools-adb

      # Étape 7 : Démarrer l'emulateur Genymotion
      - name: Démarrer l'emulateur Genymotion
        run: |
          cd android-emulator
          ./start.sh Pixel_6_API_30

      # Étape 8 : Exécuter les tests Appium
      - name: Exécuter les tests Appium
        run: |
          # Exécutez vos commandes de test Appium ici
          # Par exemple :
          # npx appium-test --app ./android-app.apk

      # Étape 9 : Arrêter le serveur Appium
      - name: Arrêter le serveur Appium
        run: pkill appium

      # Étape 10 : Générer le rapport Allure
      - name: Générer le rapport Allure
        uses: actions/checkout@v2
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages

      # Étape 11 : Construire le rapport Allure
      - name: Construire le rapport Allure
        uses: simple-elf/allure-report-action@master
        id: allure-report
        with:
          allure_results: allure-results
          gh_pages: gh-pages
          allure_report: allure-report
          allure_history: allure-history

      # Étape 12 : Déployer le rapport sur GitHub Pages
      - name: Déployer le rapport sur GitHub Pages
        uses: peaceiris/actions-gh-pages@v2
        env:
          PERSONAL_TOKEN: ${{ secrets.TOKEN }}
          PUBLISH_BRANCH: gh-pages
          PUBLISH_DIR: allure-history
